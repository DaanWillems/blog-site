<!DOCTYPE html>
<html lang="en-us"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <meta name="description" content="Small summary">  

  <title>
    
      Building a database (part 2): Write-ahead logging and SSTable organization
    
  </title>


  <link rel="shortcut icon" type="image/x-icon" href="/" />
  
  
  
  <link rel="stylesheet" href="/css/main.18e297f9c7b534b566a0a070712181cc69b4f1155e1b8d1fe541304605c4f6ab7d7460a557a004bf67fd09787aef348cf619f6dd8d310362898a41b1465ddd4d.css" integrity="sha512-GOKX&#43;ce1NLVmoKBwcSGBzGm08RVeG40f5UEwRgXE9qt9dGClV6AEv2f9CXh67zSM9hn23Y0xA2KJikGxRl3dTQ==" />
  
</head>
<body a="dark">
        <main class="page-content" aria-label="Content">
            <div class="w">
                <div class="post-meta">
                    <a href="/">..</a>

                    <p>
                        <time datetime="2025-07-26 00:00:00 &#43;0000 UTC">
                            2025-07-26
                        </time>
                    </p>
                </div>

<article>
    <h1>Building a database (part 2): Write-ahead logging and SSTable organization</h1>

    
        <aside >
            <nav id="TableOfContents">
  <ul>
    <li><a href="#cleaning-up">Cleaning up</a></li>
    <li><a href="#write-ahead-logging">Write-ahead logging</a></li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
        </aside>
    

    <p>In this part we&rsquo;ll improve the persistence and crash resistance of the database. We will also start to work on organizing multiple SSTables on disk.</p>
<h2 id="cleaning-up">Cleaning up</h2>
<p>First we&rsquo;ll clean up the code a bit. All code files relating to the database internals are moved into a database package. We&rsquo;ll create a database.go file that will become the entrypoint into the package.</p>
<p><img src="/images/directory-layout-part2.png" alt="Image displaying directory layout"></p>
<p>In the database.go file we&rsquo;ll add logic for starting the database</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">database</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;bufio&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Config</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">MemtableSize</span> <span style="color:#66d9ef">int</span> <span style="color:#75715e">//Threshold of entries before flushing to disk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">memtable</span> <span style="color:#a6e22e">Memtable</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">config</span> <span style="color:#a6e22e">Config</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">InitializeDatabase</span>(<span style="color:#a6e22e">cfg</span> <span style="color:#a6e22e">Config</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memtable</span> = <span style="color:#a6e22e">NewMemtable</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">config</span> = <span style="color:#a6e22e">cfg</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The MemtableSize is the maximum number of entries the memtable may contain before flushing to disk. At a later point it will make more sense to look at the total number of bytes in the table, as entries can vary in size.</p>
<p>We&rsquo;ll also need methods for inserting and retrieving data</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Insert</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>, <span style="color:#a6e22e">values</span> []<span style="color:#66d9ef">string</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">byteValues</span> <span style="color:#f92672">:=</span> [][]<span style="color:#66d9ef">byte</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">v</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">values</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">byteValues</span> = append(<span style="color:#a6e22e">byteValues</span>, []byte(<span style="color:#a6e22e">v</span>))
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">entry</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">MemtableEntry</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">id</span>:      []<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">id</span>)},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">values</span>:  <span style="color:#a6e22e">byteValues</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">deleted</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memtable</span>.<span style="color:#a6e22e">Insert</span>(<span style="color:#a6e22e">entry</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">memtable</span>.<span style="color:#a6e22e">entries</span>.<span style="color:#a6e22e">Len</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">MemtableSize</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">table</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateSSTableFromMemtable</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">memtable</span>, <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">table</span>.<span style="color:#a6e22e">Flush</span>(<span style="color:#e6db74">&#34;./test.db&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">memtable</span> = <span style="color:#a6e22e">NewMemtable</span>() <span style="color:#75715e">// Reset memtable after flushing
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The insert function is also responsible for flushing and refreshing the memtable when it exceeds the maximum number of entires</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//First check in the memtable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">entry</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">memtable</span>.<span style="color:#a6e22e">Get</span>([]<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">id</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">entry</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">entry</span>.<span style="color:#a6e22e">values</span>[<span style="color:#ae81ff">0</span>], <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//For now we only have the capability of writing and reading a single sstable from disk
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fd</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;./test.db&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">reader</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">fd</span>) <span style="color:#75715e">// creates a new reader
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">entry</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">SearchInSSTable</span>(<span style="color:#a6e22e">reader</span>, []<span style="color:#66d9ef">byte</span>{byte(<span style="color:#a6e22e">id</span>)})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		panic(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">entry</span>.<span style="color:#a6e22e">values</span>[<span style="color:#ae81ff">0</span>], <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The query function first looks into the memtable, and only after that into the SSTable on disk</p>
<h2 id="write-ahead-logging">Write-ahead logging</h2>
<p>The database has a basic level of persistence now. But if the program crashes or is terminated before writing the memtable to disk, this data is lost.</p>
<p>To avoid this problem we can keep a separate file on disk to which all database operations are logged first called a WAL (Write-ahead log). Because this file is append only, it&rsquo;ll be very quick. Each time an entry gets inserted, we&rsquo;ll write it to the WAL first, and only then insert it into the memtable.</p>
<p>Should our program crash, we can read and &lsquo;replay&rsquo; the WAL to restore the state of the memtable. Once the memtable gets written to disk we can discard the WAL.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this part we implemented a WAL to make sure data in the memtable is crash resistant. We also added the ability to store and search multiple SSTables on disk. It&rsquo;s starting to look like an actual database!</p>
<p>In the next part we&rsquo;ll work on a very important feature: compacting tables. We&rsquo;ll implement a background process that automatically scans and compacts SSTables to reclaim disk space and improve lookup speeds.</p>

</article>

            </div>
        </main>
    </body></html>
